#!/bin/bash
# GRAIN - Code Quality Tools
# Usage: ./scripts/format [check|fix|tidy]

set -e

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
SOURCE_DIR="$PROJECT_ROOT/Source"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Find all source files (for formatting)
find_sources() {
  find "$SOURCE_DIR" -type f \( -name "*.cpp" -o -name "*.h" -o -name "*.hpp" \) 2>/dev/null || true
}

# Find compilable source files (excludes Tests/ — included via #include, not a standalone translation unit)
find_tidy_sources() {
  find "$SOURCE_DIR" -path "*/Tests/*" -prune -o -type f \( -name "*.cpp" -o -name "*.h" -o -name "*.hpp" \) -print 2>/dev/null || true
}

# Check if tools are installed
check_tools() {
  local missing=()

  if ! command -v clang-format &>/dev/null; then
    missing+=("clang-format")
  fi

  if ! command -v clang-tidy &>/dev/null; then
    missing+=("clang-tidy")
  fi

  if [ ${#missing[@]} -ne 0 ]; then
    echo -e "${RED}Error: Missing tools: ${missing[*]}${NC}"
    echo ""
    echo "Install on macOS with Homebrew:"
    echo "  brew install llvm"
    echo "  # Add to PATH: export PATH=\"/opt/homebrew/opt/llvm/bin:\$PATH\""
    echo ""
    exit 1
  fi
}

# Format check (dry-run)
format_check() {
  echo -e "${YELLOW}Checking code formatting...${NC}"

  local files
  files=$(find_sources)

  if [ -z "$files" ]; then
    echo -e "${YELLOW}No source files found in $SOURCE_DIR${NC}"
    exit 0
  fi

  local failed=0

  for file in $files; do
    if ! clang-format --dry-run --Werror "$file" 2>/dev/null; then
      echo -e "${RED}  ✗ $file${NC}"
      failed=1
    else
      echo -e "${GREEN}  ✓ $file${NC}"
    fi
  done

  if [ $failed -eq 1 ]; then
    echo ""
    echo -e "${RED}Formatting issues found. Run './scripts/format.sh fix' to auto-fix.${NC}"
    exit 1
  fi

  echo -e "${GREEN}All files properly formatted!${NC}"
}

# Format fix (in-place)
format_fix() {
  echo -e "${YELLOW}Formatting source files...${NC}"

  local files
  files=$(find_sources)

  if [ -z "$files" ]; then
    echo -e "${YELLOW}No source files found in $SOURCE_DIR${NC}"
    exit 0
  fi

  for file in $files; do
    clang-format -i "$file"
    echo -e "${GREEN}  ✓ $file${NC}"
  done

  echo -e "${GREEN}Formatting complete!${NC}"
}

# Run clang-tidy (uses compile_commands.json for correct JUCE flags and translation units)
run_tidy() {
  echo -e "${YELLOW}Running clang-tidy...${NC}"

  if [ ! -f "$PROJECT_ROOT/compile_commands.json" ]; then
    echo -e "${RED}Error: compile_commands.json not found in project root.${NC}"
    echo "  Generate it with:"
    echo "  python3 scripts/generate_compile_commands.py"
    exit 1
  fi

  local files
  files=$(find_tidy_sources)

  if [ -z "$files" ]; then
    echo -e "${YELLOW}No source files found in $SOURCE_DIR${NC}"
    exit 0
  fi

  local failed=0

  for file in $files; do
    echo -e "${YELLOW}Analyzing: $file${NC}"
    # Filter out clang-tidy informational lines (suppressed counts, header-filter hints)
    local output
    output=$(clang-tidy -p "$PROJECT_ROOT" -header-filter='.*/Source/.*' "$file" 2>&1 \
      | grep -v "^$" \
      | grep -v "warnings generated" \
      | grep -v "Suppressed .* warnings" \
      | grep -v "Use -header-filter" \
      | grep -v "Use -system-headers" \
      || true)
    if [ -n "$output" ]; then
      echo "$output"
      failed=1
    fi
  done

  if [ $failed -eq 1 ]; then
    echo -e "${RED}clang-tidy found issues.${NC}"
    exit 1
  fi

  echo -e "${GREEN}clang-tidy analysis complete!${NC}"
}

# Show usage
usage() {
  echo "GRAIN Code Quality Tools"
  echo ""
  echo "Usage: $0 [command]"
  echo ""
  echo "Commands:"
  echo "  check   Check formatting (dry-run, no changes)"
  echo "  fix     Auto-fix formatting issues"
  echo "  tidy    Run clang-tidy static analysis"
  echo "  all     Run format check + clang-tidy"
  echo ""
  echo "Examples:"
  echo "  $0 check    # CI: verify formatting"
  echo "  $0 fix      # Dev: auto-format before commit"
  echo "  $0 tidy     # Dev: find potential bugs"
}

# Main
main() {
  check_tools

  case "${1:-}" in
  check)
    format_check
    ;;
  fix)
    format_fix
    ;;
  tidy)
    run_tidy
    ;;
  all)
    format_check
    echo ""
    run_tidy
    ;;
  *)
    usage
    exit 1
    ;;
  esac
}

main "$@"
